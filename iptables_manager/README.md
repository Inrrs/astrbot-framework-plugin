# IPTables Manager Pro 插件

## 概述

`Iptables Manager Pro` 是一个为 AstrBot 设计的强大插件，旨在通过聊天机器人安全、便捷地管理远程服务器上的 `iptables` 端口转发规则。它特别适用于需要为多个用户提供临时或长期端口映射服务的场景，例如游戏服务器、开发环境共享等。

插件内置了完整的审批流程、IP 白名单机制和操作原子性保障，确保所有更改都经过授权且稳定可靠。

## 主要功能

- **远程管理**：通过 SSH 安全连接到远程主机，执行 `iptables` 命令。
- **审批流程**：普通用户申请端口映射后，需要由指定的管理员审批，通过后规则才会生效。
- **IP 白名单**：只有在白名单内的内网 IP 地址才能申请端口转发，增强了安全性。
- **端口冲突检测**：在申请和审批阶段自动检测外网端口是否已被占用。
- **原子操作与自动回滚**：在添加或删除规则时，如果任何一步操作失败，系统会自动撤销（回滚）所有已执行的命令，防止产生不完整的或错误的规则。
- **简洁的消息反馈**：操作成功时返回简洁的确认信息，失败时提供详细的错误日志。
- **详细的规则查询**：管理员可以查看当前所有有效的端口映射规则，并关联到申请人信息。
- **权限分离**：严格区分管理员指令和普通用户指令，普通用户仅能使用申请命令。

## 命令文档

所有命令都以 `/端口映射` 作为前缀。

---

### 管理员指令

> **注意**：以下所有命令都需要管理员权限才能执行。

#### 1. 设置主机信息

这是使用此插件的第一步，必须先设置远程主机信息。

- **命令**：`/端口映射 设置主机 <ip[:端口]> <用户名> <密码>`
- **说明**：设置用于 SSH 连接的远程服务器的 IP、端口（默认为 22）、用户名和密码。设置成功后，插件会自动检查并尝试启用远程主机的 IP 转发功能。
- **示例**：`/端口映射 设置主机 1.2.3.4:22 root mypassword`

#### 2. 设置审批员

- **命令**：`/端口映射 设置审批`
- **说明**：在您希望接收审批通知的聊天窗口（私聊或群聊）发送此命令，将您自己设置为端口转发申请的审批员。
- **示例**：`/端口映射 设置审批`

#### 3. 管理 IP 白名单

- **命令**：`/端口映射 白名单 <添加|删除> <ip1> <ip2> ...`
- **说明**：添加或删除允许申请端口转发的内网 IP 地址。
- **示例**：
  - `/端口映射 白名单 添加 192.168.1.100 192.168.1.101`
  - `/端口映射 白名单 删除 192.168.1.101`

#### 4. 查看命令

- **查看主机**：`/端口映射 查看主机` - 显示当前配置的 SSH 主机信息。
- **查看白名单**：`/端口映射 查看白名单` - 列出所有在白名单中的 IP 地址。
- **查看规则**：`/端口映射 查看规则` - 显示当前所有已生效的端口映射规则，并提示如何删除。
- **待审列表**：`/端口映射 待审列表` - 查看所有等待审批的申请。

#### 5. 审批申请

- **命令**：`/端口映射 同意 <id|all>`
- **说明**：同意一个或所有待处理的申请。`id` 通常是申请人的 QQ 号。
- **示例**：
  - `/端口映射 同意 123456789`
  - `/端口映射 同意 all`

- **命令**：`/端口映射 拒绝 <id|all>`
- **说明**：拒绝一个或所有待处理的申请。
- **示例**：
  - `/端口映射 拒绝 123456789`
  - `/端口映射 拒绝 all`

#### 6. 直接管理规则

- **命令**：`/端口映射 添加 <内网IP:端口> <外网端口>`
- **说明**：管理员直接添加一条端口转发规则，无需审批。
- **示例**：`/端口映射 添加 192.168.1.100:25565 25565`

- **命令**：`/端口映射 删除 <端口1> <端口2> ...`
- **说明**：根据外网端口号删除一条或多条端口转发规则。
- **示例**：`/端口映射 删除 25565 8080`

---

### 用户指令

#### 1. 申请端口转发

- **命令**：`/端口映射 申请 <内网IP:端口> <外网端口> <备注用途>`
- **说明**：提交一个端口转发申请。提交前，请确保您的内网 IP 已被管理员加入白名单，且申请的外网端口未被占用。
- **示例**：`/端口映射 申请 192.168.1.100:25565 25565 我的世界服务器`

## 工作流程

1.  **管理员**使用 `/端口映射 设置主机` 和 `/端口映射 设置审批` 完成初始配置。
2.  **管理员**使用 `/端口映射 白名单 添加` 将允许申请的内网 IP 加入白名单。
3.  **用户**使用 `/端口映射 申请` 命令提交端口转发请求。
4.  **管理员**收到申请通知。
5.  **管理员**使用 `/端口映射 待审列表` 查看所有申请，并使用 `/端口映射 同意 <id>` 或 `/端口映射 拒绝 <id>` 进行处理。
6.  申请通过后，`iptables` 规则会自动应用到远程服务器上，用户会收到通知。
7.  **管理员**可随时使用 `/端口映射 查看规则` 和 `/端口映射 删除` 来管理现有的规则。
