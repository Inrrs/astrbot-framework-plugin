# OpenResty Proxy Manager 插件

## 概述

`OpenResty Proxy Manager` 是一个为 AstrBot 设计的插件，旨在通过聊天机器人安全、便捷地管理远程服务器上的 `OpenResty` 反向代理配置。它适用于需要为多个用户或服务动态创建和管理域名代理的场景。

插件内置了完整的审批流程、IP白名单和端口禁用机制，确保所有代理配置都经过授权且安全可靠。

## 主要功能

- **WebUI配置**：所有核心参数（SSH连接、OpenResty路径、审批员）均通过AstrBot管理后台图形化配置，无需记忆复杂指令。
- **环境自动配置**：强大的 `检查环境` 指令，可自动发现OpenResty主配置，并在需要时自动创建配置文件、添加`include`指令，极大简化了首次部署。
- **纯Python实现**：使用 `asyncssh` 库进行远程操作，无需在宿主机安装 `sshpass` 等外部依赖。
- **多协议支持**：通过 SSH 管理 OpenResty 的 HTTP, HTTPS (七层) 和 TCP/UDP (四层) 反向代理。TCP 协议申请会自动同时转发 UDP 流量。
- **审批流程**：普通用户申请端口代理后，需要由指定的管理员审批，通过后配置才会生效并重载 OpenResty 服务。
- **IP 白名单**：只有在白名单内的内网 IP 地址才能作为代理的目标，增强了安全性。
- **端口禁用机制**：
    - 内置禁用常用端口 (如 80, 443)。
    - 支持通过 `forbidden_ports.txt` 文件自定义禁用端口或端口范围。
    - 管理员可通过指令动态添加禁用端口。
- **智能冲突检测**：在申请和审批阶段自动检测外网端口是否已被本地记录或远程服务占用，并为用户推荐可用端口。
- **配置审计与同步**：`查看规则` 指令可清晰对比本地记录与远程服务器的真实配置差异，并可通过 `同步配置` 指令一键修复不一致。
- **原子化配置更新**：远程更新配置时，先上传临时文件并测试语法，成功后再替换旧配置并重载服务，确保服务不中断。
- **权限分离**：严格区分管理员指令和普通用户指令。
- **智能通知**：HTTP/S 申请通过后，用户会自动收到包含完整访问地址 (域名+端口) 的通知消息。

## 安装与配置

1.  **安装插件**: 将插件放置于 `data/plugins` 目录下，重启 AstrBot。
2.  **安装依赖**: AstrBot 会自动根据 `requirements.txt` 文件安装 `asyncssh` 依赖。
3.  **配置插件**:
    - 进入 AstrBot WebUI -> 插件管理 -> OpenResty Proxy Manager。
    - 填写 **SSH 配置**：远程服务器的IP、端口、用户名和密码。
    - 填写 **OpenResty 配置**：主域名、各项配置文件的远程路径、SSL证书目录。
    - 在 **审批员** 列表中，添加有权审批申请的管理员QQ号。
    - 保存配置。
4.  **初始化环境**: 配置完成后，请务必在聊天窗口发送一次 `/反代 检查环境` 命令。该命令会自动完成远程服务器的配置检查和路径设置，是插件正常运行的关键步骤。

## 前置要求

- **远程服务器**:
  - 已安装 OpenResty。
  - SSH 服务已开启。
  - 用于连接的SSH用户需要有执行 `sudo openresty`、`sudo mv`、`sudo rm`、`sudo mkdir` 等命令的权限（通常建议配置免密 `sudo`）。
- **AstrBot 服务器**:
  - 可以访问远程服务器的 SSH 端口。

## 附录：服务器环境准备

本附录为初次配置远程服务器的用户提供指导。

### 1. 安装 OpenResty

请根据您的 Linux 发行版选择合适的安装方式。

#### 在 Debian / Ubuntu 上安装
```bash
# 1. 安装依赖
sudo apt-get update
sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates

# 2. 导入 GPG 密钥
wget -O - https://openresty.org/package/pubkey.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/openresty.gpg

# 3. 添加 OpenResty 官方软件源 (以Debian bookworm为例，请根据实际情况调整)
echo "deb http://openresty.org/package/debian bookworm openresty" | sudo tee /etc/apt/sources.list.d/openresty.list

# 4. 安装 OpenResty
sudo apt-get update
sudo apt-get -y install openresty
```

#### 在 CentOS / RHEL 上安装
```bash
# 1. 添加 yum 源
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo

# 2. 安装 OpenResty
sudo yum install -y openresty
```

安装完成后，建议启动并设置开机自启：
```bash
sudo systemctl start openresty
sudo systemctl enable openresty
```

### 2. 放置 SSL 证书 (HTTPS 需求)

如果您需要使用 `https` 协议，请将您的 SSL 证书和私钥文件上传到服务器。

1.  **获取证书**: 您需要一个证书文件 (通常是 `.pem` 或 `.crt` 后缀) 和一个私钥文件 (`.key` 后缀)。
2.  **上传文件**: 将这两个文件上传到您在插件 WebUI **OpenResty 配置** -> **SSL证书路径** 中所指定的目录。
3.  **命名规则**: 插件会根据您在 WebUI 中设置的 **主域名** 来寻找证书文件。例如，如果主域名是 `proxy.example.com`，插件将寻找 `proxy.example.com.pem` 和 `proxy.example.com.key` 文件。

### 3. 配置免密 Sudo (重要)

为了安全和自动化，插件要求 SSH 连接的用户能够无密码执行特定的 `sudo` 命令。

1.  **编辑 sudoers 文件**: 在远程服务器上执行 `sudo visudo` 命令。
2.  **添加配置**: 在文件末尾添加以下行，请将 `your_username` 替换为您在插件中配置的 SSH 用户名，并使用 `which openresty` 确认 `openresty` 的准确路径。

    ```
    # 允许 openresty_proxy_manager 插件执行必要命令
    your_username ALL=(ALL) NOPASSWD: /usr/local/openresty/bin/openresty, /bin/mv, /bin/rm, /bin/mkdir, /bin/cp, /bin/cat, /bin/sed, /bin/touch, /bin/sh, /usr/bin/tee, /usr/bin/ss, /usr/bin/systemctl
    ```
3.  **保存退出**: 保存并退出编辑器。

完成以上步骤后，您的服务器环境便已准备就绪。

## 命令文档

所有命令都以 `/反代` 作为前缀。

---

### 管理员指令

> **注意**：以下所有命令都需要管理员权限才能执行。

#### 1. 环境与配置

- **命令**：`/反代 检查环境`
- **说明**：**（首次配置必须执行）** 检查并自动配置远程环境。它会测试SSH连接，自动发现OpenResty路径，创建所需的配置文件，并向主配置中添加`include`指令。
- **示例**：`/反代 检查环境`

- **命令**：`/反代 查看配置`
- **说明**：显示当前在 WebUI 中配置的核心参数。
- **示例**：`/反代 查看配置`

- **命令**：`/反代 同步配置`
- **说明**：当本地记录与远程服务器配置不一致时，此命令会根据本地记录强制覆盖并更新远程服务器的配置。
- **示例**：`/反代 同步配置`

#### 2. 管理IP白名单

- **命令**：`/反代 白名单添加 <ip1> [ip2]...`
- **说明**：向IP白名单中添加一个或多个IP地址，使用空格分隔。
- **示例**：`/反代 白名单添加 192.168.1.100 192.168.1.101`

- **命令**：`/反代 白名单删除 <ip1> [ip2]...`
- **说明**：从IP白名单中删除一个或多个IP地址，使用空格分隔。
- **示例**：`/反代 白名单删除 192.168.1.101`

- **命令**：`/反代 查看白名单`
- **说明**：查看当前IP白名单列表。
- **示例**：`/反代 查看白名单`

#### 3. 管理禁用端口

- **命令**：`/反代 禁用 端口 <端口1> [端口2]...`
- **说明**：动态添加一个或多个需要禁用的外网端口。这些端口会被追加到 `forbidden_ports.txt` 文件中。
- **示例**：`/反代 禁用 端口 9000 9001`

#### 4. 审批与规则管理

- **命令**：`/反代 审批`
- **说明**：查看所有待审批的代理申请。
- **示例**：`/反代 审批`

- **命令**：`/反代 同意 <申请ID1> [申请ID2]...` 或 `/反代 同意 all`
- **说明**：同意一个或多个代理申请。对于 `http` 或 `https` 类型的申请，用户将在批准通知中收到完整的访问URL。
- **示例**：`/反代 同意 user123_tcp_25565` 或 `/反代 同意 all`

- **命令**：`/反代 拒绝 <申请ID1> [申请ID2]...` 或 `/反代 拒绝 all`
- **说明**：拒绝一个或多个代理申请。
- **示例**：`/反代 拒绝 user123_tcp_25565` 或 `/反代 拒绝 all`

- **命令**：`/反代 查看规则`
- **说明**：查看并比对本地记录和远程服务器上的所有规则，高亮显示不一致的条目。
- **示例**：`/反代 查看规则`

#### 5. 直接管理规则

- **命令**：`/反代 添加 <http|https|tcp> <内网IP:端口> <外网端口>`
- **说明**：管理员直接添加一条代理规则，无需审批。
- **示例**：`/反代 添加 tcp 192.168.1.102:25565 25565`

- **命令**：`/反代 删除 <外网端口1 或 规则ID1> [外网端口2 或 规则ID2]...`
- **说明**：根据外网端口或规则ID删除一个或多个已生效的规则。
- **示例**：`/反代 删除 80` 或 `/反代 删除 user123_tcp_25565`

---

### 用户指令

#### 1. 申请端口代理

- **命令**：`/反代 申请 <http|https|tcp> <内网IP:端口> <外网端口> <备注>`
- **说明**：提交一个端口反向代理申请。如果申请的端口不可用，系统会尝试推荐其他可用端口。`tcp` 协议申请会自动同时转发 `udp` 流量。
- **示例**：
  - `/反代 申请 http 192.168.1.101:3000 8081 我的Web服务`
  - `/反代 申请 tcp 192.168.1.103:22 2222 SSH访问`

## 工作流程

1.  **管理员**在 AstrBot WebUI 中完成插件的 **SSH** 和 **OpenResty** 相关配置，并添加**审批员**。
2.  **管理员**使用 `/反代 检查环境` 自动完成远程服务器的配置和初始化。
3.  **管理员**使用 `/反代 白名单添加` 将允许申请的内网 IP 加入白名单。
4.  **用户**使用 `/反代 申请` 命令提交端口代理请求。
5.  **审批员**收到通知，并使用 `/反代 同意` 或 `/反代 拒绝` 进行处理。
6.  申请通过后，插件会自动更新远程 `OpenResty` 配置并平滑重载服务。
7.  **管理员**可随时使用 `/反代 查看规则` 来审计当前生效的规则，并使用 `同步配置` 解决不一致问题。
